let uid,uname,upair={};auth.onAuthStateChanged(async function(e){e?(uid=e.uid,uname=await getUsernameByUid(uid),upair[uid]=uname,getMyDesks(),getAllDesks()):window.location.href="index.html"});async function createDesk(){var e=document.getElementById("deskName").value,a=document.getElementById("deskImage").files[0];let i=firebase.storage().ref("desks/"+e),t=i.put(a);await t.on("state_changed",function(e){},function(e){console.error(e)},function(){t.snapshot.ref.getDownloadURL().then(function(e){console.log("File available at",e)})});let s,n=firebase.storage().ref("desks/"+e);await n.getDownloadURL().then(function(e){s=e});a=document.getElementById("deskDescription").value;let d=await database.ref().child("desks").push();a={deskName:e,did:d.key,deskImage:s,owner:uid,description:a,userList:[uname],followers:1,likes:0,dislikes:0,rating:0};await d.set(a),await database.ref("users/"+uid+"/desksList").push().set(d.key),window.location.href="desk.html"}async function getDidByDeskName(a){let i;return await database.ref("desks/").once("value",function(e){e.forEach(function(e){e=e.val();e.deskName==a&&(i=e.did)})}),i}async function getDeskNameByDid(e){let a;return await database.ref("desks/"+e).once("value",function(e){e=e.val();a=e.deskName}),a}async function findDesk(){var a=await getDidByDeskName(document.getElementById("findDesk").value);let e=document.getElementById("deskInfo"),i=document.createElement("button"),t=!1;await database.ref("users/"+uid+"/desksList").once("value",function(e){e.forEach(function(e){e.val()==a&&(t=!0)})}),null==a?(i.innerHTML="Create",i.setAttribute("data-toggle","modal"),i.setAttribute("data-target","#createDesk")):t?(i.innerHTML="Open",i.onclick="room/"+a):(i.innerHTML="Join",i.addEventListener("click",function(){joinDesk(a)})),$("#deskInfo").empty(),e.appendChild(i)}async function joinDesk(e){await database.ref("desks/"+e+"/userList").push().set(uid);let a;await database.ref("users/"+uid+"/desksList").push().set(e),await database.ref("desks/"+e).once("value",function(e){a=e.val().followers}),a+=1,await database.ref("desks/"+e).update({followers:a}),window.location.href="desk.html"}async function join(e){joinDesk(e.split(" ")[1])}async function getAllDesks(){let a=[];await database.ref("desks").orderByChild("followers").once("value",function(e){e.forEach(function(e){a.push(e.val().did)})}),$("#allDesks").empty(),getDesks=document.getElementById("allDesks");for(let e=0;e<a.length;e++)await database.ref("desks/"+a[e]).once("value",async function(e){var a,i=e.val(),t='<div class="flip-card-front">'+("<img src="+i.deskImage+'alt="Avatar" class="card-img">')+"</div>",s="<h5>"+i.deskName+"</h5>",n='<p id="inline-para">'+i.description+"</p>",d='<p id="inline-para">Followers : '+i.followers+"</p>",l='<p id="inline-para">Rating : '+i.rating+"</p>",e='<p id="inline-para">Likes : '+i.likes+"</p>";let o=!1;var r=i.did;await database.ref("users/"+uid+"/desksList").once("value",function(e){e.forEach(function(e){e.val()==r&&(o=!0)})});let c;c=o?"<button onclick=\"window.location.href='room/"+r+"';\">Open</button>":'<button onclick="join(this.innerHTML)">Join '+r+"</button>",a='<div class="flip-card" style="float:left;">'+('<div class="flip-card-inner">'+t+('<div class="flip-card-back"> '+s+n+d+l+e+c+"</div>")+"</div>")+"</div>",$("#allDesks").append(a)})}async function getMyDesks(){let t=[];await database.ref("users/"+uid+"/desksList").once("value",function(e){e.forEach(function(e){t.push(e.val())})}),$("#myDesks").empty(),getDesks=document.getElementById("myDesks"),0==t.length&&$("#myDesks").append('<div class="flip-card" style="float:left;"\'"><div class="flip-card-inner"><div class="flip-card-front"><img src="emptyCard.png" alt="Avatar" class="card-img"></div><div class="flip-card-back"> <h5>Empty Page List</h5><p id="inline-para">Choose a card from below or create your own fan page</p></div></div></div>');for(let i=0;i<t.length;i++)await database.ref("desks/"+t[i]).once("value",function(e){var a=e.val(),e=(e='<div class="flip-card" style="float:left;" onclick="location.href= \'room/'+t[i]+"'\">")+('<div class="flip-card-inner">'+('<div class="flip-card-front">'+("<img src="+a.deskImage+'alt="Avatar" class="card-img">')+"</div>")+('<div class="flip-card-back"> '+("<h5>"+a.deskName+"</h5>")+('<p id="inline-para">'+a.description+"</p>")+('<p id="inline-para">Followers : '+a.followers+"</p>")+('<p id="inline-para">Rating : '+a.rating+"</p>")+('<p id="inline-para">Likes : '+a.likes+"</p>")+('<p id="inline-para">Dislikes : '+a.dislikes+"</p>")+"</div>")+"</div>")+"</div>";$("#myDesks").append(e)})}