var color;did=window.location.href.split("/")[4];let username,uimage;auth.onAuthStateChanged(async function(e){e&&(uid=e.uid,await database.ref("users/"+uid).once("value",function(e){username=e.val().username,uimage=e.val().image}),loadDList())});async function uploadImageMessage(e,t){var n=Date.now().toString();let a=firebase.storage().ref("messages/"+t+"/"+n),s=a.put(e);await s.on("state_changed",async function(e){},async function(e){console.error(e)},async function(){await s.snapshot.ref.getDownloadURL().then(async function(e){console.log("File available at",e);let a,s=firebase.storage().ref("messages/"+t+"/"+n);await s.getDownloadURL().then(function(e){a=e}),await database.ref("desks/"+t+"/messages/").push().set({image:uimage,sender:username,messageDetails:{type:"image/gif",message:a}})})})}async function sendText(){var e=document.getElementById("textMessage").value,a=document.getElementById("imageMessage");return console.log(e),console.log(a.files),0==e.length&&0==a.files.length||(document.getElementById("textMessage").value="",0<e.length&&await database.ref("desks/"+did+"/messages/").push().set({image:uimage,sender:username,messageDetails:{type:"text/plain",message:e}}),console.log(a),0<a.files.length&&(await uploadImageMessage(a.files[0],did),removeElement(document.getElementById("imageMessage").files[0]))),!1}async function loadDList(){let a=[];await database.ref("users/"+uid+"/desksList").once("value",function(e){e.forEach(function(e){a.push(e.val())})}),$("#dList").empty();for(let e=0;e<a.length;e++){var s="";s+="<span onclick=\"location.href='"+a[e]+"'\">",s+=await getDeskNameByDid(a[e])+"</span>",$("#dList").append(s)}}async function unfollow(){let a;await database.ref("desks/"+did).once("value",function(e){a=e.val().followers}),--a;let s;await database.ref("desks/"+did+"/userList").once("value",async function(e){await e.forEach(function(e){e.val()==uid&&(s=e.key)})}),await database.ref("desks/"+did+"/userList").child(s).remove(),await database.ref("desks/"+did).update({followers:a}),await database.ref("users/"+uid+"/desksList").once("value",async function(e){await e.forEach(function(e){e.val()==did&&(s=e.key)})}),await database.ref("users/"+uid+"/desksList").child(s).remove(),window.location.href="../desk.html"}async function like(){let a;await database.ref("desks/"+did).once("value",function(e){a=e.val().likes}),a+=1,await database.ref("desks/"+did).update({likes:a})}async function dislike(){let a;await database.ref("desks/"+did).once("value",function(e){a=e.val().dislikes}),a+=1,await database.ref("desks/"+did).update({dislikes:a})}async function openNav(){document.getElementById("mySidenav").style.width="250px",document.getElementById("main").style.marginLeft="250px",await database.ref("desks/"+did).once("value",async function(e){var a=e.val(),s="<div>",t='<img style="height:450px; object-fit: cover;" src='+a.deskImage+"/>",e="<p>"+a.deskName+"</p>",s="<div>"+t+("<p>"+a.description+"</p>")+"<hr/>"+("<p>Owner: "+await getUsernameByUid(a.owner)+"</p>")+"<hr/>"+("<p>Followers: "+a.followers+"</p>")+"<hr/>"+("<p>Rating: "+a.rating+"</p>")+"<hr/>"+("<p>Likes: "+a.likes+"</p>")+"<hr/>"+("<p>Dislikes: "+a.dislikes+"</p>");s+="</div>",$("#deskInfoo").empty(),$("#deskInfoo").append(s),$("#dName").empty(),$("#dName").append(e)})}function closeNav(){document.getElementById("mySidenav").style.width="0",document.getElementById("main").style.marginLeft="0"}function getRandomColor(){var e="1234567".split("");color="#";for(var a=0;a<6;a++)color+=e[Math.floor(7*Math.random())]}function removeElement(e){e.parentNode.removeChild(e)}database.ref("desks/"+did+"/messages/").on("child_added",async function(s){let e=document.getElementById("messageContainer"),t=document.createElement("p");getRandomColor();let a=new Image;a.style.display="inline-block",a.src=s.val().image;let n=document.createElement("span");if(n.style.color=color,n.innerHTML=s.val().sender,t.appendChild(a),t.appendChild(n),"text/plain"==s.val().messageDetails.type){let e=document.createElement("span");e.innerHTML=": "+s.val().messageDetails.message,t.appendChild(e)}else{let e=new Image;e.src=s.val().messageDetails.message,e.className="message";let a=document.createElement("div");a.append(e),t.append(a)}e.append(t),e.scrollTop=e.scrollHeight});